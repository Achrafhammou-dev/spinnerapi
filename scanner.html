<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI QR Verifier</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; min-height: 100vh; }
        .main-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 450px; margin: auto; }
        #reader { width: 100%; border-radius: 15px; overflow: hidden; background: #000; }
        .result-box { display: none; margin-top: 20px; padding: 20px; border-radius: 12px; text-align: center; font-weight: bold; }
        .btn-scan { background: #4f46e5; color: white; border: none; padding: 12px 25px; border-radius: 10px; font-weight: 600; width: 100%; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container text-center">
    <div class="main-card animate__animated animate__fadeIn">
        <h3 class="mb-4">QR System Scanner</h3>
        
        <div id="loading-db" class="mb-3">
            <div class="loader"></div> <span class="ms-2">Syncing Database...</span>
        </div>

        <div id="reader"></div>

        <div id="result" class="result-box animate__animated"></div>
        
        <button id="reset-btn" class="btn btn-scan mt-3" style="display:none;" onclick="restartScanner()">Scan Again</button>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxDrho2ble-Tiq1U6HqgxDG70XnqPqeN-ra1bHahB0qNSRG9oIoEzH1iQKX6DKS5vBG/exec';
    
    let database = [];
    const html5QrCode = new Html5Qrcode("reader");

    // Load Database from Google Sheets
    async function fetchDatabase() {
        try {
            const response = await fetch(API_URL);
            database = await response.json();
            document.getElementById('loading-db').style.display = 'none';
            startScanner();
        } catch (err) {
            document.getElementById('loading-db').innerHTML = "❌ Connection Error";
        }
    }

    function startScanner() {
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
    }

    async function onScanSuccess(decodedText) {
        await html5QrCode.stop();
        const display = document.getElementById('result'); // Use ID "result"
        const nextBtn = document.getElementById('reset-btn'); // Use ID "reset-btn"
        const code = decodedText.trim();
        
        display.style.display = 'block';
        display.innerHTML = "Validating...";

        // Search in Column G (Index 6)
        const row = database.find(r => r[6] && r[6].toString().trim() === code);

        if (!row) {
            showResult("CODE INTROUVABLE", "bg-danger text-white", "animate__shakeX");
        } else if (row[7] === "USED") { // Check Column H (Index 7)
            showResult("DÉJÀ UTILISÉ", "bg-warning text-dark", "animate__headShake");
        } else {
            const success = await markAsUsed(code);
            if(success) {
                showResult("VALIDE - MARQUÉ UTILISÉ", "bg-success text-white", "animate__bounceIn");
            } else {
                showResult("ERREUR SERVEUR", "bg-secondary text-white", "");
            }
        }
        nextBtn.style.display = 'block';
    }

    // Helper function to update UI
    function showResult(text, classes, animation) {
        const display = document.getElementById('result');
        display.className = `result-box animate__animated ${animation} ${classes}`;
        display.innerHTML = `<h4>${text}</h4>`;
    }

    // API Call to mark as used
    async function markAsUsed(code) {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: "markAsUsed", 
                    code: code 
                }),
                headers: { 'Content-Type': 'text/plain' }
            });
            const result = await response.text();
            return result === "SUCCESS";
        } catch (e) { return false; }
    }

    function restartScanner() {
        document.getElementById('result').style.display = 'none';
        document.getElementById('reset-btn').style.display = 'none';
        // Re-fetch database to get updated "USED" statuses before starting again
        fetchDatabase(); 
    }

    fetchDatabase();
</script>

</body>
</html>