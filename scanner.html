<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BK Staff - Validator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root {
            --bg-dark: #121212;
            --card-dark: #1E1E1E;
            --accent-orange: #ED7902;
            --accent-red: #D62300;
            --text-grey: #B0B0B0;
            --success-green: #00C851;
        }

        body { 
            background: var(--bg-dark); 
            font-family: 'Segoe UI', sans-serif; 
            color: white;
            min-height: 100vh;
            display: flex; flex-direction: column;
        }

        /* LOGIN PIN SCREEN */
        #pin-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column;
        }
        .pin-input {
            background: var(--card-dark); border: 2px solid var(--accent-orange);
            color: white; text-align: center; font-size: 2rem; letter-spacing: 10px;
            width: 200px; padding: 10px; border-radius: 10px;
        }

        /* MAIN UI */
        .navbar-custom {
            background: var(--card-dark);
            border-bottom: 2px solid var(--accent-orange);
            padding: 15px;
        }
        
        .scanner-frame {
            position: relative;
            background: black;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(237, 121, 2, 0.3);
            margin: 20px auto;
            max-width: 500px;
            aspect-ratio: 1/1; /* Carr√© parfait */
        }
        
        #reader { width: 100%; height: 100%; object-fit: cover; }

        /* Overlay de vis√©e */
        .scan-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: 50px solid rgba(0,0,0,0.6);
            box-sizing: border-box;
            pointer-events: none;
            z-index: 10;
        }
        .scan-line {
            width: 100%; height: 2px; background: var(--accent-red);
            position: absolute; top: 50%;
            animation: scan-move 2s infinite ease-in-out;
            box-shadow: 0 0 10px var(--accent-red);
        }

        /* Result Card */
        .result-modal {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card-dark);
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            padding: 30px;
            transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            border-top: 4px solid var(--accent-orange);
        }
        .result-modal.active { transform: translateY(0); }

        .status-icon { font-size: 4rem; margin-bottom: 10px; }
        .data-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 10px 0; }
        .data-label { color: var(--text-grey); }
        .data-val { font-weight: bold; }

        .btn-action {
            width: 100%; padding: 15px; border-radius: 12px;
            font-weight: bold; text-transform: uppercase; border: none;
            margin-top: 15px;
        }
        .btn-validate { background: var(--success-green); color: white; }
        .btn-close { background: #333; color: white; }

        @keyframes scan-move { 0%, 100% { top: 10%; opacity: 0; } 50% { top: 90%; opacity: 1; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="pin-screen">
        <img src="https://upload.wikimedia.org/wikipedia/commons/c/cc/Burger_King_2020.svg" width="80" class="mb-4">
        <h3 class="mb-4">STAFF ACCESS</h3>
        <input type="password" id="staff-pin" class="pin-input" placeholder="PIN" maxlength="4">
        <button onclick="checkPin()" class="btn btn-warning mt-4 fw-bold px-5">ENTER</button>
        <p id="pin-error" class="text-danger mt-3 hidden">Access Denied</p>
    </div>

    <div id="app-interface" class="hidden">
        <nav class="navbar-custom d-flex justify-content-between align-items-center">
            <span class="fw-bold text-white"><i class="bi bi-qr-code-scan me-2"></i> BK SCANNER</span>
            <span class="badge bg-warning text-dark">STAFF MODE</span>
        </nav>

        <div class="container mt-3">
            <div class="scanner-frame">
                <div id="reader"></div>
                <div class="scan-overlay">
                    <div class="scan-line"></div>
                </div>
            </div>
            <p class="text-center text-muted small mt-2">Point camera at customer QR Code</p>
        </div>

        <div id="result-modal" class="result-modal text-center">
            <div id="status-icon" class="status-icon"></div>
            <h2 id="status-text" class="mb-1">Checking...</h2>
            <p id="status-sub" class="text-muted small mb-4">Wait a moment</p>
            
            <div id="customer-data" class="text-start hidden">
                <div class="data-row">
                    <span class="data-label">Prize</span>
                    <span class="data-val text-warning" id="res-prize">Whopper</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Name</span>
                    <span class="data-val" id="res-name">Achraf</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Ref</span>
                    <span class="data-val small" id="res-ref">BK-12938</span>
                </div>
            </div>

            <button id="btn-consume" class="btn-action btn-validate hidden" onclick="consumeCode()">
                <i class="bi bi-check-circle-fill"></i> VALIDATE PRIZE
            </button>
            <button class="btn-action btn-close" onclick="resetScanner()">
                SCAN NEXT
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        const API_URL = '/api/scan'; 
        let html5QrCode;
        let currentCode = "";
        let staffPin = "";

        // 1. PIN Logic
        function checkPin() {
            const input = document.getElementById('staff-pin').value;
            if(input === "1234") { // Simple front check, real check is API
                staffPin = input;
                document.getElementById('pin-screen').classList.add('animate__animated', 'animate__fadeOutUp');
                setTimeout(() => {
                    document.getElementById('pin-screen').classList.add('hidden');
                    document.getElementById('app-interface').classList.remove('hidden');
                    startScanner();
                }, 500);
            } else {
                document.getElementById('pin-error').classList.remove('hidden');
            }
        }

        // 2. Scanner Logic
        function startScanner() {
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: 250 }, 
                onScanSuccess
            ).catch(err => console.log("Cam error", err));
        }

        function onScanSuccess(decodedText) {
            html5QrCode.stop(); // Pause scan
            currentCode = decodedText.trim();
            verifyCode(currentCode);
        }

        // 3. API Verification
        async function verifyCode(code) {
            showModal("loading");
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code: code, pin: staffPin, action: 'check' })
                });
                const data = await res.json();

                if (data.status === "VALID") {
                    showModal("valid", data);
                } else if (data.status === "USED") {
                    showModal("used", data);
                } else if (data.status === "NOT_FOUND") {
                    showModal("invalid");
                } else {
                    showModal("error");
                }

            } catch(e) {
                showModal("error");
            }
        }

        // 4. Consume Logic (Marquer comme mang√©)
        async function consumeCode() {
            const btn = document.getElementById('btn-consume');
            btn.innerHTML = "VALIDATING...";
            btn.disabled = true;

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code: currentCode, pin: staffPin, action: 'consume' })
                });
                const data = await res.json();
                
                if(data.status === "SUCCESS") {
                    showModal("success_consumed");
                } else {
                    alert("Error updating database");
                }
            } catch(e) {
                alert("Connection error");
            }
        }

        // 5. UI Helper
        function showModal(state, data = null) {
            const modal = document.getElementById('result-modal');
            const icon = document.getElementById('status-icon');
            const title = document.getElementById('status-text');
            const sub = document.getElementById('status-sub');
            const details = document.getElementById('customer-data');
            const btnConsume = document.getElementById('btn-consume');

            modal.classList.add('active');
            details.classList.add('hidden');
            btnConsume.classList.add('hidden');

            if (state === "loading") {
                icon.innerHTML = '‚è≥';
                title.innerText = "Checking...";
                title.style.color = "white";
                sub.innerText = "Verifying with server";
            }
            else if (state === "valid") {
                icon.innerHTML = '‚úÖ';
                title.innerText = "VALID CODE";
                title.style.color = "#00C851";
                sub.innerText = "This code is good to go!";
                
                document.getElementById('res-prize').innerText = data.prize;
                document.getElementById('res-name').innerText = data.name;
                document.getElementById('res-ref').innerText = currentCode;
                
                details.classList.remove('hidden');
                btnConsume.classList.remove('hidden');
            }
            else if (state === "used") {
                icon.innerHTML = '‚ö†Ô∏è';
                title.innerText = "ALREADY USED";
                title.style.color = "#ffbb33";
                sub.innerText = `Used by ${data.name} on ${data.date || 'Unknown'}`;
            }
            else if (state === "invalid") {
                icon.innerHTML = 'üö´';
                title.innerText = "INVALID CODE";
                title.style.color = "#ff4444";
                sub.innerText = "Code not found in system.";
            }
            else if (state === "success_consumed") {
                icon.innerHTML = 'üéâ';
                title.innerText = "DONE!";
                title.style.color = "#00C851";
                sub.innerText = "Prize delivered successfully.";
                btnConsume.classList.add('hidden');
            }
        }

        function resetScanner() {
            document.getElementById('result-modal').classList.remove('active');
            startScanner();
        }
    </script>
</body>
</html>